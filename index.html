<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body {
  margin: 0;
  background: #f2f2f2;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  text-align: center;
  color: #111;
}
#container { display: none; }
#label { font-size:12px; opacity:0.6; margin-bottom:10px; letter-spacing:1px; text-transform:uppercase; }
#timer { font-size:72px; font-weight:600; letter-spacing:2px; margin-bottom:20px; }
#progressContainer { width:260px; height:4px; background:#dddddd; border-radius:4px; overflow:hidden; margin:0 auto; }
#progressBar { height:100%; width:0%; background:#222; transition:width 0.5s ease; }
</style>
</head>
<body>
<div id="container">
  <div id="label"></div>
  <div id="timer">--:--</div>
  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
</div>
<script>
const API_KEY = "AIzaSyBulpufS7w0xT0QjHIlg75Em8TXRAJfNaA";
const CALENDAR_IDS = ["f98a845d2d487246693d4bc740c763e8869338b01cf0ee3711c21436200e344d@group.calendar.google.com"];

let wakeEvents=[], bedEvents=[], now = new Date();

async function fetchEvents() {
  now = new Date();
  const timeMin = new Date(now.getTime() - 12*60*60*1000).toISOString();
  const timeMax = new Date(now.getTime() + 48*60*60*1000).toISOString();

  let events = [];
  for(const id of CALENDAR_IDS){
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(id)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
    try{
      const res = await fetch(url);
      const data = await res.json();
      if(data.items) events = events.concat(data.items);
    } catch(err){ console.log("Calendar fetch error:", err); }
  }

  wakeEvents = events.filter(e => e.summary && e.summary.toLowerCase()==="wake" && e.start.dateTime)
                     .map(e => new Date(e.start.dateTime)).sort((a,b)=>a-b);
  bedEvents = events.filter(e => e.summary && e.summary.toLowerCase()==="bed" && e.start.dateTime)
                    .map(e => new Date(e.start.dateTime)).sort((a,b)=>a-b);

  if(wakeEvents.length && bedEvents.length){
    document.getElementById("container").style.display="block";
  }
}

function getPhase() {
  now = new Date();
  let phaseStart, phaseEnd, label;

  // Find next wake after now
  const nextWake = wakeEvents.find(w=>w>now) || wakeEvents[0];
  // Find next bed after now
  const nextBed = bedEvents.find(b=>b>now) || bedEvents[0];

  // Determine current phase
  if(wakeEvents.some(w=>w<=now) && nextBed > now){
    // Awake: last wake before now â†’ next bed after that
    const lastWake
