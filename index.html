<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Time Left Awake</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 18px;
    text-align: center;
    color: #111;
  }

  .timer {
    font-size: 56px;
    font-weight: 600;
    letter-spacing: 1px;
    margin-bottom: 14px;
  }

  .inputs {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin-bottom: 16px;
  }

  .inputs div {
    display: flex;
    flex-direction: column;
    font-size: 10px;
    opacity: 0.6;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  input[type="time"] {
    font-size: 14px;
    padding: 4px;
    border: 1px solid #ddd;
    background: #fff;
  }

  .bar-container {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
  }

  .bar {
    height: 100%;
    width: 0%;
    background: #222;
    transition: width 0.4s ease;
  }

  .percent {
    font-size: 10px;
    margin-top: 6px;
    opacity: 0.5;
  }
</style>
</head>

<body>

<div class="timer" id="countdown">--:--</div>

<div class="inputs">
  <div>
    <label>Wake</label>
    <input type="time" id="wakeTime">
  </div>
  <div>
    <label>Bed</label>
    <input type="time" id="bedTime">
  </div>
</div>

<div class="bar-container">
  <div class="bar" id="progressBar"></div>
</div>
<div class="percent" id="percentText">0%</div>

<script>
const API_KEY = "AIzaSyBulpufS7w0xT0QjHIlg75Em8TXRAJfNaA";
const CALENDAR_ID = "f98a845d2d487246693d4bc740c763e8869338b01cf0ee3711c21436200e344d@group.calendar.google.com";

const countdown = document.getElementById("countdown");
const wakeInput = document.getElementById("wakeTime");
const bedInput = document.getElementById("bedTime");
const bar = document.getElementById("progressBar");
const percentText = document.getElementById("percentText");

function formatTimeForInput(date) {
  return date.toTimeString().slice(0,5);
}

async function fetchCalendarDefaults() {
  const now = new Date();
  const startOfDay = new Date(now);
  startOfDay.setHours(0,0,0,0);

  const endWindow = new Date(now.getTime() + 36*60*60*1000);

  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&timeMin=${startOfDay.toISOString()}&timeMax=${endWindow.toISOString()}&singleEvents=true&orderBy=startTime`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.items) return;

    const wakeEvent = data.items.find(e =>
      e.summary &&
      e.summary.toLowerCase() === "wake" &&
      new Date(e.start.dateTime).toDateString() === now.toDateString()
    );

    const bedEvent = data.items.find(e =>
      e.summary &&
      e.summary.toLowerCase() === "bed" &&
      new Date(e.end.dateTime) > now
    );

    if (wakeEvent) {
      wakeInput.value = formatTimeForInput(new Date(wakeEvent.start.dateTime));
    }

    if (bedEvent) {
      bedInput.value = formatTimeForInput(new Date(bedEvent.end.dateTime));
    }

    update();
  } catch (err) {
    console.log("Calendar error:", err);
  }
}

function parseTime(baseDate, timeStr) {
  const [h, m] = timeStr.split(":").map(Number);
  const d = new Date(baseDate);
  d.setHours(h, m, 0, 0);
  return d;
}

function update() {
  const now = new Date();

  if (!wakeInput.value || !bedInput.value) return;

  let wake = parseTime(now, wakeInput.value);
  let bed = parseTime(now, bedInput.value);

  if (bed <= wake) {
    bed.setDate(bed.getDate() + 1);
  }

  if (now < wake && bed.getDate() !== wake.getDate()) {
    wake.setDate(wake.getDate() - 1);
  }

  const totalMs = bed - wake;
  const remainingMs = Math.max(0, bed - now);
  const elapsedMs = Math.min(totalMs, Math.max(0, now - wake));

  if (now < wake) {
    const msUntilWake = wake - now;
    const mins = Math.floor(msUntilWake / 60000);
    countdown.textContent =
      `${String(Math.floor(mins / 60)).padStart(2,"0")}:${String(mins % 60).padStart(2,"0")}`;
  } else if (now >= bed) {
    countdown.textContent = "00:00";
  } else {
    const mins = Math.floor(remainingMs / 60000);
    countdown.textContent =
      `${String(Math.floor(mins / 60)).padStart(2,"0")}:${String(mins % 60).padStart(2,"0")}`;
  }

  const percent = Math.max(0, Math.min(100, Math.round((elapsedMs / totalMs) * 100)));
  bar.style.width = percent + "%";
  percentText.textContent = percent + "% used";
}

fetchCalendarDefaults();
setInterval(update, 60000);
wakeInput.addEventListener("change", update);
bedInput.addEventListener("change", update);
</script>

</body>
</html>
