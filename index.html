<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body {
  margin: 0;
  background: #f2f2f2;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  text-align: center;
  color: #111;
}

#container {
  display: none;
}

#label {
  font-size: 12px;
  opacity: 0.6;
  margin-bottom: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

#timer {
  font-size: 72px;
  font-weight: 600;
  letter-spacing: 2px;
  margin-bottom: 20px;
}

#progressContainer {
  width: 260px;
  height: 4px;
  background: #dddddd;
  border-radius: 4px;
  overflow: hidden;
  margin: 0 auto;
}

#progressBar {
  height: 100%;
  width: 0%;
  background: #222;
  transition: width 0.5s ease;
}
</style>
</head>
<body>

<div id="container">
  <div id="label"></div>
  <div id="timer">--:--</div>
  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
</div>

<script>
const API_KEY = "AIzaSyBulpufS7w0xT0QjHIlg75Em8TXRAJfNaA";
const CALENDAR_IDS = ["f98a845d2d487246693d4bc740c763e8869338b01cf0ee3711c21436200e344d@group.calendar.google.com"];

let wakeEvent = null;
let bedEvent = null;
let nextWakeEvent = null; // for sleep phase

async function fetchWakeBed() {
  const now = new Date();
  const timeMin = new Date(now.getTime() - 12*60*60*1000).toISOString(); // 12h back
  const timeMax = new Date(now.getTime() + 48*60*60*1000).toISOString(); // 48h ahead

  let events = [];
  for (const id of CALENDAR_IDS) {
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(id)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.items) events = events.concat(data.items);
    } catch (err) {
      console.log("Calendar fetch error:", err);
    }
  }

  // Get all wake and bed events
  const wakeEvents = events
    .filter(e => e.summary && e.summary.toLowerCase() === "wake" && e.start.dateTime)
    .map(e => ({start: new Date(e.start.dateTime), end: new Date(e.end.dateTime)}))
    .sort((a,b)=>a.start-b.start);

  const bedEvents = events
    .filter(e => e.summary && e.summary.toLowerCase() === "bed" && e.start.dateTime)
    .map(e => ({start: new Date(e.start.dateTime), end: new Date(e.end.dateTime)}))
    .sort((a,b)=>a.start-b.start);

  // Find the active awake phase
  wakeEvent = wakeEvents.find(w => w.start <= now && bedEvents.some(b => b.end > w.start));
  if (!wakeEvent) wakeEvent = wakeEvents.find(w => w.start > now); // next wake if none ongoing

  if (wakeEvent) {
    // Find the bed that follows this wake
    bedEvent = bedEvents.find(b => b.end > wakeEvent.start);
    // Find the next wake after this bed
    nextWakeEvent = wakeEvents.find(w => w.start > (bedEvent ? bedEvent.end : now));
  }

  if (wakeEvent && bedEvent) {
    document.getElementById("container").style.display = "block";
  }
}

function updateTimer() {
  if (!wakeEvent || !bedEvent) return;

  const now = new Date();
  let phaseStart, phaseEnd, label;

  if (now >= wakeEvent.start && now < bedEvent.end) {
    // Awake phase
    phaseStart = wakeEvent.start;
    phaseEnd = bedEvent.end;
    label = "TIME REMAINING AWAKE";
  } else {
    // Sleep phase
    phaseStart = bedEvent.end;
    phaseEnd = nextWakeEvent ? nextWakeEvent.start : new Date(phaseStart.getTime() + 24*60*60*1000);
    label = "TIME REMAINING ASLEEP";
  }

  const totalMs = phaseEnd - phaseStart;
  const remainingMs = phaseEnd - now;
  const elapsedMs = now - phaseStart;

  const mins = Math.max(0, Math.floor(remainingMs / 60000));
  const hh = String(Math.floor(mins / 60)).padStart(2,"0");
  const mm = String(mins % 60).padStart(2,"0");

  document.getElementById("label").textContent = label;
  document.getElementById("timer").textContent = `${hh}:${mm}`;

  const percent = Math.max(0, Math.min(100, (elapsedMs / totalMs) * 100));
  document.getElementById("progressBar").style.width = percent + "%";
}

// Init
fetchWakeBed();
setInterval(fetchWakeBed, 300000); // refresh events every 5 min
setInterval(updateTimer, 1000);     // update timer every second
</script>

</body>
</html>
